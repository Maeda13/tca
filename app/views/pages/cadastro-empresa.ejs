<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cadastro</title>
    <link rel="stylesheet" href="/css/cadastro-empresa.css" />
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100900;1,100900&display=swap');
      @import url('https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100900;1,100900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
      @import url('https://fonts.googleapis.com/css2?family=Albert+Sans:ital,wght@0,100900;1,100900&family=Montserrat:ital,wght@0,100900;1,100900&family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
    </style>

    
    <style>
      .field-error {
        color: #c62828;
        font-size: 12px;
        margin-top: 6px;
        display: block;
      }

      input.invalid {
        border-color: #c62828;
        box-shadow: 0 0 0 3px rgba(198, 40, 40, 0.06);
      }

      ul.server-errors {
        list-style: none;
        padding: 8px 12px;
        background: #fff0f0;
        border: 1px solid #ffd0d0;
        border-radius: 8px;
        color: #c62828;
      }

      ul.server-errors li {
        margin: 4px 0;
      }
    </style>
  </head>

  <body>
    <header>
      <%- include('../partials/menuempresa') %>
    </header>

    <main class="cad-container">
      <h1 class="cadastro">Cadastro</h1>

      <form class="cad-form" action="/cadastro-empresa" method="POST" novalidate>
        <ol class="form-steps" aria-hidden="true">
          <li>
            <span class="step active">1</span>
            <span class="step-label">Empresa</span>
          </li>
          <li>
            <span class="step">2</span>
            <span class="step-label">Representante<br />responsável</span>
          </li>
          <li>
            <span class="step">3</span>
            <span class="step-label">Eixo de<br />atuação</span>
          </li>
        </ol>

        <br />

        <section class="form-section">
          <p>Digite os dados da sua empresa para se cadastrar</p>

          <% if (typeof errors !== 'undefined' && errors && errors.length) { %>
            <ul class="server-errors">
              <% errors.forEach(function (err) { %>
                <li><%= err.msg %></li>
              <% }) %>
            </ul>
          <% } %>

          <% var e = (errors && errors.length) ? errors.find(function (it) { return it.param === 'razao_social'; }) : null; %>
          <input
            type="text"
            id="razao_social"
            name="razao_social"
            placeholder="Razão social (nome jurídico)"
            value="<%= (form && form.razao_social) ? form.razao_social : '' %>"
          />
          <span class="field-error"><%= e ? e.msg : '' %></span>

          <% var e = (errors && errors.length) ? errors.find(function (it) { return it.param === 'nome_fantasia'; }) : null; %>
          <input
            type="text"
            id="nome_fantasia"
            name="nome_fantasia"
            placeholder="Nome Fantasia"
            value="<%= (form && form.nome_fantasia) ? form.nome_fantasia : '' %>"
          />
          <span class="field-error"><%= e ? e.msg : '' %></span>

          <% var e = (errors && errors.length) ? errors.find(function (it) { return it.param === 'cnpj'; }) : null; %>
          <input
            type="text"
            id="cnpj"
            name="cnpj"
            placeholder="CNPJ"
            inputmode="numeric"
            maxlength="18"
            value="<%= (form && form.cnpj) ? form.cnpj : '' %>"
          />
          <span class="field-error"><%= e ? e.msg : '' %></span>

          <% var e = (errors && errors.length) ? errors.find(function (it) { return it.param === 'telefone'; }) : null; %>
          <input
            type="tel"
            id="telefone"
            name="telefone"
            placeholder="(00) 00000-0000"
            inputmode="tel"
            maxlength="15"
            value="<%= (form && form.telefone) ? form.telefone : '' %>"
          />
          <span class="field-error"><%= e ? e.msg : '' %></span>

          <label style="margin-top:10px; font-size:0.85rem; color:#666">Logradouro da sede</label>

          <% var e = (errors && errors.length) ? errors.find(function (it) { return it.param === 'logradouro'; }) : null; %>
          <input
            type="text"
            id="logradouro"
            name="logradouro"
            placeholder="Rua"
            value="<%= (form && form.logradouro) ? form.logradouro : '' %>"
          />
          <span class="field-error"><%= e ? e.msg : '' %></span>

          <% var e = (errors && errors.length) ? errors.find(function (it) { return it.param === 'cidade'; }) : null; %>
          <input
            type="text"
            id="cidade"
            name="cidade"
            placeholder="Cidade"
            value="<%= (form && form.cidade) ? form.cidade : '' %>"
          />
          <span class="field-error"><%= e ? e.msg : '' %></span>

          <% var e = (errors && errors.length) ? errors.find(function (it) { return it.param === 'estado'; }) : null; %>
          <select id="estado" name="estado">
            <option value="">Selecione o estado</option>
            <option value="AC" <%= (form && form.estado==='AC') ? 'selected' : '' %>>Acre (AC)</option>
            <option value="AL" <%= (form && form.estado==='AL') ? 'selected' : '' %>>Alagoas (AL)</option>
            <option value="AP" <%= (form && form.estado==='AP') ? 'selected' : '' %>>Amapá (AP)</option>
            <option value="AM" <%= (form && form.estado==='AM') ? 'selected' : '' %>>Amazonas (AM)</option>
            <option value="BA" <%= (form && form.estado==='BA') ? 'selected' : '' %>>Bahia (BA)</option>
            <option value="CE" <%= (form && form.estado==='CE') ? 'selected' : '' %>>Ceará (CE)</option>
            <option value="ES" <%= (form && form.estado==='ES') ? 'selected' : '' %>>Espírito Santo (ES)</option>
            <option value="GO" <%= (form && form.estado==='GO') ? 'selected' : '' %>>Goiás (GO)</option>
            <option value="MA" <%= (form && form.estado==='MA') ? 'selected' : '' %>>Maranhão (MA)</option>
            <option value="MT" <%= (form && form.estado==='MT') ? 'selected' : '' %>>Mato Grosso (MT)</option>
            <option value="MS" <%= (form && form.estado==='MS') ? 'selected' : '' %>>Mato Grosso do Sul (MS)</option>
            <option value="MG" <%= (form && form.estado==='MG') ? 'selected' : '' %>>Minas Gerais (MG)</option>
            <option value="PA" <%= (form && form.estado==='PA') ? 'selected' : '' %>>Pará (PA)</option>
            <option value="PB" <%= (form && form.estado==='PB') ? 'selected' : '' %>>Paraíba (PB)</option>
            <option value="PR" <%= (form && form.estado==='PR') ? 'selected' : '' %>>Paraná (PR)</option>
            <option value="PE" <%= (form && form.estado==='PE') ? 'selected' : '' %>>Pernambuco (PE)</option>
            <option value="PI" <%= (form && form.estado==='PI') ? 'selected' : '' %>>Piauí (PI)</option>
            <option value="RJ" <%= (form && form.estado==='RJ') ? 'selected' : '' %>>Rio de Janeiro (RJ)</option>
            <option value="RN" <%= (form && form.estado==='RN') ? 'selected' : '' %>>Rio Grande do Norte (RN)</option>
            <option value="RS" <%= (form && form.estado==='RS') ? 'selected' : '' %>>Rio Grande do Sul (RS)</option>
            <option value="RO" <%= (form && form.estado==='RO') ? 'selected' : '' %>>Rondônia (RO)</option>
            <option value="RR" <%= (form && form.estado==='RR') ? 'selected' : '' %>>Roraima (RR)</option>
            <option value="SC" <%= (form && form.estado==='SC') ? 'selected' : '' %>>Santa Catarina (SC)</option>
            <option value="SP" <%= (form && form.estado==='SP') ? 'selected' : '' %>>São Paulo (SP)</option>
            <option value="SE" <%= (form && form.estado==='SE') ? 'selected' : '' %>>Sergipe (SE)</option>
            <option value="TO" <%= (form && form.estado==='TO') ? 'selected' : '' %>>Tocantins (TO)</option>
          </select>
          <span class="field-error"><%= e ? e.msg : '' %></span>

          <fieldset class="row">
            <% var e = (errors && errors.length) ? errors.find(function (it) { return it.param === 'cep'; }) : null; %>
            <input class="col" type="text" id="cep" name="cep" placeholder="00000-000" inputmode="numeric" maxlength="9" value="<%= (form && form.cep) ? form.cep : '' %>" />
            <span class="field-error"><%= e ? e.msg : '' %></span>

            <input class="col" type="text" id="complemento" name="complemento" placeholder="Complemento" value="<%= (form && form.complemento) ? form.complemento : '' %>" />
            <span class="field-error"></span>
          </fieldset>
        </section>

        <br />
        <br />

        <button type="submit" class="btn-primary">Próximo</button>
      </form>
    </main>

    <footer></footer>

    <script src="/js/script.js"></script>
    <script>
      (function () {
        const form = document.querySelector('.cad-form');
        if (!form) return;

        const messages = {
          razao_social: 'Razão social é obrigatória',
          nome_fantasia: 'Nome fantasia é obrigatória',
          cnpj: 'CNPJ inválido — informe 14 números',
          telefone: 'Telefone inválido — informe 10 ou 11 números',
          logradouro: 'Logradouro é obrigatório',
          cidade: 'Cidade é obrigatória',
          estado: 'Estado é obrigatório',
          cep: 'CEP inválido — informe 8 números',
        };

        function digits(value) {
          return (value || '').replace(/\D/g, '');
        }

        function validateInput(input) {
          const id = input.id;
          const raw = input.value || '';
          let ok = true;

          if (id === 'cnpj') ok = /^\d{14}$/.test(digits(raw));
          else if (id === 'telefone') ok = /^\d{10,11}$/.test(digits(raw));
          else if (id === 'cep') ok = /^\d{8}$/.test(digits(raw));
          else if (id === 'complemento') ok = true; // optional field
          else ok = raw.trim().length > 0;

          const span =
            input.nextElementSibling && input.nextElementSibling.classList.contains('field-error')
              ? input.nextElementSibling
              : null;

          if (!ok) {
            input.classList.add('invalid');
            if (span) span.textContent = messages[id] || 'Campo inválido';
          } else {
            input.classList.remove('invalid');
            if (span) {
              // clear only our generic message; if server message existed but user fixed input, clear it
              span.textContent = '';
            }
          }

          return ok;
        }

        // attach live validation
        function formatCNPJ(digits) {
          // digits: string with only numbers, up to 14 chars
          const part1 = digits.slice(0, 2);
          const part2 = digits.slice(2, 5);
          const part3 = digits.slice(5, 8);
          const part4 = digits.slice(8, 12);
          const part5 = digits.slice(12, 14);
          let out = '';
          if (part1) out += part1;
          if (part2) out += '.' + part2;
          if (part3) out += '.' + part3;
          if (part4) out += '/' + part4;
          if (part5) out += '-' + part5;
          return out;
        }

        function formatPhone(digitsStr) {
          // format as (AA) NNNNN-NNNN for 11 digits or (AA) NNNN-NNNN for 10 digits
          const d = (digitsStr || '').slice(0, 11);
          if (d.length === 0) return '';
          if (d.length <= 2) return '(' + d + ') ';
          if (d.length <= 6) return '(' + d.slice(0,2) + ') ' + d.slice(2);
          if (d.length === 10) return '(' + d.slice(0,2) + ') ' + d.slice(2,6) + '-' + d.slice(6);
          // 11 digits
          return '(' + d.slice(0,2) + ') ' + d.slice(2,7) + '-' + d.slice(7);
        }

          form.querySelectorAll('input').forEach((input) => {
          // normalize numeric fields while typing and apply mask for CNPJ
          input.addEventListener('input', () => {
            if (['cnpj', 'telefone', 'cep'].includes(input.id)) {
              const max = input.id === 'cnpj' ? 14 : input.id === 'telefone' ? 11 : 8;
              let cleaned = digits(input.value).slice(0, max);
              if (input.id === 'cnpj') {
                // show masked cnpj while typing
                const masked = formatCNPJ(cleaned);
                if (input.value !== masked) input.value = masked;
              } else if (input.id === 'telefone') {
                // show masked telefone with dots while typing
                const masked = formatPhone(cleaned);
                if (input.value !== masked) input.value = masked;
              } else {
                // cep: keep numeric only (will be formatted by other handlers)
                if (input.value !== cleaned) input.value = cleaned;
              }
            }
            validateInput(input);
          });

          input.addEventListener('blur', () => validateInput(input));

          // show formatted placeholder for CNPJ on focus
          if (input.id === 'cnpj') {
            input.addEventListener('focus', function () {
              this.placeholder = '00.000.000/0000-00';
            });
            input.addEventListener('blur', function () {
              this.placeholder = 'CNPJ';
            });
          }
        });

        // ensure we send raw digits to server: strip mask before submit
        form.addEventListener('submit', function (e) {
          ['cnpj', 'telefone', 'cep'].forEach(function (id) {
            const el = form.querySelector('#' + id);
            if (el) el.value = digits(el.value);
          });
        }, { capture: true });

        // final check on submit
        form.addEventListener('submit', function (e) {
          let allOk = true;
          form.querySelectorAll('input').forEach((input) => {
            if (!validateInput(input)) allOk = false;
          });
          if (!allOk) {
            e.preventDefault();
            const first = form.querySelector('input.invalid');
            if (first) first.focus();
          }
        });
      })();
    </script>
  </body>
</html>
